function LeadPage(){var request_action;var request_ctrl;var exportExcelUrl;var vci_markup='<div class="col-xs-12 nopadding"> <div class="col-sm-4 col-xs-12"> <i class="icon-cf icon-cf-warning"></i> Is this requirement by an Agent? <span> <a href="javascript:void(0);" class="custom-link report-agent" report-broker="true" lead_id="{lead_id}">Report</a> </span> </div> <div class="col-sm-4 text-left col-xs-12"> <i class="icon-cf icon-cf-mail"></i>{email}</div> <div class="col-sm-4 text-right col-xs-12"> <div class="pull-right"> <div style="margin-top:8px;">{mobile}</div></div><i class="icon-cf icon-cf-mobile fa-3x pull-right" style=" "></i> </div> </div>';this.init=function(){try{var page=$("[sub-page-name]").attr("sub-page-name");switch(page){case"getleads-page":initializeGetLeadsPage();break;case"manage-leads":initializeManageLeadsPage();break;default:break}bindGenericEventHandlers()}catch(e){console.error("Error intializing Profile Page :: "+e.message)}};function initializeGetLeadsPage(){var listing_id;var curEl;var broker_id=$("#broker_id").val();$(".custom-chosen").chosen({search_contains:true});$(".drop-down-ms").multiselect({numberDisplayed:1});var search_intent=$(".search_intent button.active").attr("data-intent")||"sale";if(search_intent=="sale"){$("#budget-section").show()}else{if(search_intent=="rent"){$("#rent-section").show()}}var locality_suggestor=new NewAutoSuggest("get-leads-filter-location",$("#get-leads-filter-location").val(),null,{targetElemName:"property_location_filter[]",targetElemId:"gl_hidden_fields_container",suggestionSeperator:"|",multiSel:1,autosuggestClass:"greyborder",pickedSuggestionDivId:"get-leads_hidden_fields_container",onMissMarkup:"Could not find any matches for your input",itemType:"locality",hiddenFieldDivId:"gl_hidden_fields_container",setLoadingImage:"0",parentHaveScroll:"content",selCallbackFunction:function(){var inputs=$("#gl_hidden_fields_container input");var chosenLocalities=$("#localities-chosen");chosenLocalities.text(inputs[inputs.length-1].getAttribute("data-locality"));if(inputs.length>1){chosenLocalities.append("+ "+(inputs.length-1)+" more")}},deSelCallbackFunction:function(){var inputs=$("#gl_hidden_fields_container input");var chosenLocalities=$("#localities-chosen");if(inputs.length==0){chosenLocalities.text("");return}chosenLocalities.text(inputs[inputs.length-1].getAttribute("data-locality"));if(inputs.length>1){chosenLocalities.append("+ "+(inputs.length-1)+" more")}}});var preloadedSugg=document.getElementById("leads_preloaded_localities").value;if(preloadedSugg&&preloadedSugg!="null"){try{locality_suggestor.selectedSuggestions=JSON.parse(preloadedSugg);locality_suggestor.loadPreLoadedSuggestions()}catch(e){console.log(e)}}$("#localities-chosen").click(function(){$("#localities-modal").modal("show")});$("#get-leads-filter-location").keypress(function(e){locality_suggestor.fetchSuggestions($("#city").val(),this.value,e)});$("#city").change(function(){$("#gl_hidden_fields_container").html("");$("#localities-chosen").html("");$("#gl_community_hidden_fields_container").html("");$("#community-chosen").html("");$("#get-leads_hidden_fields_container").html("");$("#get-community_hidden_fields_container").html("")});var community_suggestor=new NewAutoSuggest("get-leads-filter-community",$("#get-leads-filter-community").val(),null,{targetElemName:"property_name_filter[]",targetElemId:"gl_community_hidden_fields_container",suggestionSeperator:"|",multiSel:1,autosuggestClass:"greyborder",pickedSuggestionDivId:"get-community_hidden_fields_container",onMissMarkup:"Could not find any matches for your input",itemType:"apartment",hiddenFieldDivId:"gl_community_hidden_fields_container",setLoadingImage:"0",parentHaveScroll:"content",selCallbackFunction:function(){var inputs=$("#gl_community_hidden_fields_container input");var chosenLocalities=$("#community-chosen");chosenLocalities.text(inputs[inputs.length-1].getAttribute("data-locality"));if(inputs.length>1){chosenLocalities.append("+ "+(inputs.length-1)+" more")}},deSelCallbackFunction:function(){var inputs=$("#gl_community_hidden_fields_container input");var chosenLocalities=$("#community-chosen");if(inputs.length==0){chosenLocalities.text("");return}chosenLocalities.text(inputs[inputs.length-1].getAttribute("data-locality"));if(inputs.length>1){chosenLocalities.append("+ "+(inputs.length-1)+" more")}}});var comm_preloadedSugg=document.getElementById("leads_preloaded_communities").value;if(comm_preloadedSugg&&comm_preloadedSugg!="null"){try{community_suggestor.selectedSuggestions=JSON.parse(comm_preloadedSugg);community_suggestor.loadPreLoadedSuggestions()}catch(e){console.log(e)}}$("#community-chosen").click(function(){$("#community-modal").modal("show")});$("#get-leads-filter-community").keypress(function(e){community_suggestor.fetchSuggestions($("#city").val(),this.value,e)});$(".toggle-btn-grp>button").click(function(){var _this=$(this);if(_this.hasClass("active")){return}_this.parent().children().removeClass("active");var intent=_this.addClass("active").attr("data-intent");if(intent=="sale"){$("#budget-section").show();$("#rent-section").hide()}else{$("#budget-section").hide();$("#rent-section").show()}});$(".vci-btn").click(function(){$("#vci-modal").modal("show");curEl=$(this);$("#credit-val").html(curEl.attr("credit-val"));listing_id=$(this).attr("listing-id");trackPageEvents("Get Leads","See Contact Info","Init")});$("#vci-submit").click(function(){var p=curEl.hide().parent();var credit_val=curEl.attr("credit-val");p.append('<img src="/public/assets/agent/img/ajax-loader.gif"/>');var data="listing_id="+listing_id+"&listing_type=requirement&broker_id="+broker_id+"&credit_val="+credit_val;themeInteraction.postData("/agent/property-listing/show-listing-contact-info-for-broker",data,function(response){if(response.indexOf("|")>-1){var msg=response.split("|")[1];p.find("img").remove();if(msg){showNotification(msg,"error")}else{showNotification("Oops! Some error occured.","error")}return}try{response=JSON.parse(response);p.removeClass("pull-right").html(vci_markup.interpolate(response));p.parent().find("[contact-info-seen]").hide();trackPageEvents("Get Leads","See Contact Info","Success")}catch(e){console.log("Error parsing vci respone :: "+e.message);p.find("img").remove();showNotification("Some error occured.","error")}});listing_id=""});var reportBtn;$("a.report-agent").die("click");$("a.report-agent").live("click",function(){reportBtn=$(this);if(reportBtn.attr("report-broker")=="false"){return}$("#report-agent-modal").modal("show")});$("#report-agent-modal-submit").click(function(){var lead_id=reportBtn.attr("lead_id");reportBtn.attr("report-broker","false");var data="broker_id="+broker_id+"&pool_id="+lead_id;var url="agent/report/raise-lead-refund-request";var p=reportBtn.parent();p.html("<b>Reporting...</b>");trackPageEvents("Get Leads","Report as agent",lead_id);themeInteraction.postData(url,data,function(response){p.html("<b>Reported</b>")})});function applyFilters(d){var search_intent=$(".search_intent button.active").attr("data-intent");var data=$("#leads-filters input,select").serialize()+"&listings_type=requirement&r=1&search_intent="+search_intent+(d||"");if(search_intent=="sale"){data=data.replace(/_inr_budget/g,"_inr");if(parseInt($("select[name=min_inr_budget]").val())>parseInt($("select[name=max_inr_budget]").val())){alert("Budget Min value cannot be more than max!");return}}else{if(search_intent=="rent"){data=data.replace(/_inr_rent/g,"_inr");if(parseInt($("select[name=min_inr_rent]").val())>parseInt($("select[name=max_inr_rent]").val())){alert("Rent Min value cannot be more than max!");return}}}themeInteraction.tempScopeVariable=$("#advanced-filter-section").is(":visible")?"open":"";themeInteraction.fetchPage("agent/property-listing/show-property-listings",data);var gaAction,gaLabel;var c=$("#city").val();var p=l=h="";$("input[name='property_name_filter[]']").each(function(){p+=this.getAttribute("data-locality")+","});$("input[name='property_location_filter[]']").each(function(){l+=this.getAttribute("data-locality")+","});h=$("#get-leads-proptype").val()||[];gaLabel=((c?("City:"+c):"")+(l?("_Locality:"+l):"")+(p?("_Project:"+p):"")+(h.length>0?("_Property type:"+h.join()):""));if(themeInteraction.tempScopeVariable!="open"){gaAction="Filters - pri"}else{gaAction="Filters - sec";if(search_intent=="sale"){gaLabel+="Budget:"+$("[name='min_inr_budget']").val()+"-"+$("[name='max_inr_budget']").val()}else{gaLabel+="_Budget:"+$("[name='min_inr_rent']").val()+"-"+$("[name='max_inr_rent']").val()}var b=$("#get-leads-bedrooms").val()||[];var n=$("#want_within").val()||"";gaLabel+=(b.length>0?("_Bedrooms:"+b.join()):"");gaLabel+=(n?("_NeedBy:"+n):"")}if(gaLabel==""){gaLabel="None";gaAction="Filters"}trackPageEvents("Get Leads",gaAction,gaLabel)}$("select[max-page-size]").change(function(){if(this.value==""){return false}applyFilters()});$(".pagination-container li a").click(function(){var _this=$(this);var pageNum=_this.attr("data-page");if(_this.parent().hasClass("disabled")){return}if(!pageNum){return}var data="&page="+(pageNum||"");applyFilters(data)});$("#advanced-filter-button").click(function(){var _this=$(this);var state=_this.attr("state");if(state=="min"){$("#advanced-filter-section").show();_this.attr("state","max").find("span").html("-");trackPageEvents("Get Leads","Filters","Advanced expand")}else{$("#advanced-filter-section").hide();_this.attr("state","min").find("span").html("+");trackPageEvents("Get Leads","Filters","Advanced collapse")}});$("#gl-search-btn").click(function(){applyFilters()});if(themeInteraction.tempScopeVariable==="open"){$("#advanced-filter-button").click()}}function initializeManageLeadsPage(){$('[data-toggle="tooltip"]').tooltip({placement:"bottom"});exportExcelUrl="/agent/agent-report/export-as-excel";bindManageLeadsEventHandlers()}function bindManageLeadsEventHandlers(){var leadId;$("#manage-leads .agent_lead_status").click(function(){leadId=$(this).closest("tr").attr("id");broker_id=$(this).closest("tr").attr("broker_id");$("#lead-status-modal").modal("show")});$("#lead-status-modal .add-status").click(function(){var tagValue=$("#lead-status-modal .lead-status option:selected").val();var d="tg="+tagValue+"&tt=status&li="+leadId+"&broker_id="+broker_id;$("#lead-status-modal").modal("hide");themeInteraction.postData("/agent/report/add-tag",d,function(resp){var editField=$("#"+leadId);editField.find(".lead-status").find("span").text(tagValue);showNotification(resp)})});$("#manage-leads .agent_lead_remarks").click(function(){var tr=$(this).closest("tr");leadId=tr.attr("id");broker_id=tr.attr("broker_id");$("#lead-remarks-modal").modal("show");$(".lead_remark_in").val(tr.find(".lead-remark").text())});$("#lead-remarks-modal .add-remarks").click(function(){remarks=$("#lead-remarks-modal textarea.lead_remark_in").val();var d="tg="+remarks+"&tt=remark&li="+leadId+"&broker_id="+broker_id;$("#lead-remarks-modal").modal("hide");themeInteraction.postData("/agent/report/add-tag",d,function(resp){var editField=$("#"+leadId);editField.find(".lead-remark").find("span").text(remarks);editField.find(".remarks-tooltip").attr("data-original-title",remarks);showNotification(resp)})});var reportBtn;$(".report_button").click(function(){reportBtn=$(this);if(reportBtn.attr("report-broker")=="false"){return}$("#report-agent-modal").modal("show")});$("#report-agent-modal-submit").click(function(){var td=reportBtn.closest("td").html("Reporting...");var pool_id=reportBtn.attr("lead-id");var broker_id=reportBtn.attr("broker-id");var url="agent/report/raise-lead-refund-request";var data="broker_id="+broker_id+"&pool_id="+pool_id;themeInteraction.postData(url,data,function(){td.html("Reported")})});$("select[credit-filter]").change(function(){if(this.value==""){return false}var data=$("select[credit-filter]").serialize();themeInteraction.fetchPage("/agent/agent-report/index?manage_leads=1",data)});$("select[max-page-size]").change(function(){if(this.value==""){return false}var data=$(this).serialize();themeInteraction.fetchPage("/agent/agent-report/index?manage_leads=1",data)});$(".pagination-container li a").click(function(){var _this=$(this);if(_this.parent().hasClass("disabled")){return}var pageNum=_this.attr("data-page");if(!pageNum){return}var add_data=$("select[max-page-size]").serialize()||"";var total_results=$("#total_results").val();if(total_results!==undefined){add_data=add_data+"&num_results="+total_results}add_data+="&"+document.getElementById("sort_params").value;add_data+="&"+$("select[credit-filter]").serialize()||"";themeInteraction.fetchPage("/agent/agent-report/index?manage_leads=1","page="+pageNum+"&"+add_data)});$("#export-excel").click(function(){var data=$("select[credit-filter]").serialize()+"&lr=pull";window.open(exportExcelUrl+"?"+data,"_blank")});$("a[sort-title]").click(function(){var _this=$(this);var data=$("select[credit-filter]").serialize();var sortParams="so="+_this.attr("sort-title");if(_this.hasClass("table-sort-asc")){_this.removeClass("table-sort").removeClass("table-sort-asc").addClass("table-sort-desc");sortParams+="&sot=DESC"}else{_this.removeClass("table-sort").removeClass("table-sort-desc").addClass("table-sort-asc");sortParams+="&sot=ASC"}document.getElementById("sort_params").value=sortParams;data+="&"+sortParams+"&"+$("select[max-page-size]");themeInteraction.fetchPage("/agent/agent-report/index?manage_leads=1",data)});$(".table-toggle-header").on("click",function(e){if(e.target.attributes.hasOwnProperty("sort-title")){return}$(this).parent().addClass("show").find(".table-toggle-input input").focus()});$(".table-toggle-input input").blur(function(){$(this).val("").trigger("keyup").parent().parent().removeClass("show")});$(".table-toggle-input input").keyup(function(e){var data=this.value.toLowerCase();var _this=$(this);var row=_this.closest("table").find("tbody tr").hide();var col=_this.closest("th").index()+1;row.filter(function(){var $t=$(this).find("td:nth-child("+col+")");if($t.text().toLowerCase().indexOf(data)>-1){return true}return false}).show()})}function bindGenericEventHandlers(){}};